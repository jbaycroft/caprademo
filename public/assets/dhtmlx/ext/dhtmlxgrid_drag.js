//v.3.5 build 120822
/*
Copyright DHTMLX LTD. http://www.dhtmlx.com
You allowed to use this component or parts of it under GPL terms
To use it on other terms or get Professional edition of the component please contact us at sales@dhtmlx.com
*/
function dragContext(e,t,n,r,i,s,o,u,a,f){return this.source=e||"grid",this.target=t||"grid",this.mode=n||"move",this.dropmode=r||"child",this.sid=i||0,this.tid=s,this.sobj=o||null,this.tobj=u||null,this.sExtra=a||null,this.tExtra=f||null,this}dhtmlXGridObject.prototype.enableDragAndDrop=function(e){e=="temporary_disabled"?(this.dADTempOff=!1,e=!0):this.dADTempOff=!0,this.dragAndDropOff=convertStringToBoolean(e),this._drag_validate=!0,e&&(this.objBox.ondragstart=function(e){return(e||event).cancelBubble=!0,!1})},dhtmlXGridObject.prototype.setDragBehavior=function(e){this.dadmodec=this.dadmodefix=0;switch(e){case"child":this.dadmode=0,this._sbmod=!1;break;case"sibling":this.dadmode=1,this._sbmod=!1;break;case"sibling-next":this.dadmode=1,this._sbmod=!0;break;case"complex":this.dadmode=2,this._sbmod=!1;break;case"complex-next":this.dadmode=2,this._sbmod=!0}},dhtmlXGridObject.prototype.enableDragOrder=function(e){this._dndorder=convertStringToBoolean(e)},dhtmlXGridObject.prototype._checkParent=function(e,t){var n=this._h2.get[e.idd].parent;if(n.parent){for(var r=0;r<t.length;r++)if(t[r]==n.id)return!0;return this._checkParent(this.rowsAr[n.id],t)}},dhtmlXGridObject.prototype._createDragNode=function(e,t){this.editStop();if(window.dhtmlDragAndDrop.dragNode)return null;if(!this.dADTempOff)return null;e.parentObject={},e.parentObject.treeNod=this;var n=this.callEvent("onBeforeDrag",[e.parentNode.idd,e._cellIndex]);if(!n)return null;var r=[];r[this.selMultiRows?r.length:0]=e.parentNode.idd;if(this.isTreeGrid())for(var i=r.length-1;i>=0;i--)this._checkParent(this.rowsAr[r[i]],r)&&r.splice(i,1);var s=this;r.length&&this._dndorder&&r.sort(function(e,t){return s.rowsAr[e].rowIndex>s.rowsAr[t].rowIndex?1:-1});var o=this.getFirstParentOfType(_isIE?t.srcElement:t.target,"TD");o&&(this._dndExtra=o._cellIndex),this._dragged=[];for(i=0;i<r.length;i++)this.rowsAr[r[i]]&&(this._dragged[this._dragged.length]=this.rowsAr[r[i]],this.rowsAr[r[i]].treeNod=this);e.parentObject.parentNode=e.parentNode;var u=document.createElement("div");return u.innerHTML=n!==!0?n:this.rowToDragElement(e.parentNode.idd),u.style.position="absolute",u.className="dragSpanDiv",u},dhtmlXGridObject.prototype._createSdrgc=function(){this._sdrgc=document.createElement("DIV"),this._sdrgc.innerHTML="&nbsp;",this._sdrgc.className="gridDragLine",this.objBox.appendChild(this._sdrgc)},dragContext.prototype.valid=function(){if(this.sobj!=this.tobj)return!0;if(this.sid==this.tid)return!1;if(this.target=="treeGrid")for(var e=this.tid;e=this.tobj.getParentId(e);)if(this.sid==e)return!1;return!0},dragContext.prototype.close=function(){this.tobj=this.sobj=null},dragContext.prototype.copy=function(){return new dragContext(this.source,this.target,this.mode,this.dropmode,this.sid,this.tid,this.sobj,this.tobj,this.sExtra,this.tExtra)},dragContext.prototype.set=function(e,t){return this[e]=t,this},dragContext.prototype.uid=function(){for(this.nid=this.sid;this.tobj.rowsAr[this.nid];)this.nid+=(new Date).valueOf();return this},dragContext.prototype.data=function(){return this.sobj==this.tobj?this.sobj._getRowArray(this.sobj.rowsAr[this.sid]):this.source=="tree"?this.tobj.treeToGridElement(this.sobj,this.sid,this.tid):this.tobj.gridToGrid(this.sid,this.sobj,this.tobj)},dragContext.prototype.attrs=function(){return this.source=="tree"?{}:this.sobj.rowsAr[this.sid]._attrs},dragContext.prototype.childs=function(){return this.source=="treeGrid"?this.sobj._h2.get[this.sid]._xml_await?this.sobj._h2.get[this.sid].has_kids:null:null},dragContext.prototype.pid=function(){if(!this.tid)return 0;if(!this.tobj._h2)return 0;if(this.target=="treeGrid"){if(this.dropmode=="child")return this.tid;var e=this.tobj.rowsAr[this.tid],t=this.tobj._h2.get[e.idd].parent.id;if(this.alfa&&this.tobj._sbmod&&e.nextSibling){var n=this.tobj._h2.get[e.nextSibling.idd].parent.id;if(n==this.tid)return this.tid;if(n!=t)return n}return t}},dragContext.prototype.ind=function(){if(this.tid==window.unknown)return this.tobj.rowsBuffer.length;this.target=="treeGrid"&&(this.dropmode=="child"?this.tobj.openItem(this.tid):this.tobj.openItem(this.tobj.getParentId(this.tid)));var e=this.tobj.rowsBuffer._dhx_find(this.tobj.rowsAr[this.tid]);if(this.alfa&&this.tobj._sbmod&&this.dropmode=="sibling"){var t=this.tobj.rowsAr[this.tid];if(t.nextSibling&&this._h2.get[t.nextSibling.idd].parent.id==this.tid)return e+1}return e+1+(this.target=="treeGrid"&&e>=0&&this.tobj._h2.get[this.tobj.rowsBuffer[e].idd].state=="minus"?this.tobj._getOpenLenght(this.tobj.rowsBuffer[e].idd,0):0)},dragContext.prototype.img=function(){return this.target!="grid"&&this.sobj._h2?this.sobj.getItemImage(this.sid):null},dragContext.prototype.slist=function(){for(var e=[],t=0;t<this.sid.length;t++)e[e.length]=this.sid[t][this.source=="tree"?"id":"idd"];return e.join(",")},dhtmlXGridObject.prototype._drag=function(e,t,n,r){if(this._realfake)return this._fake._drag();var i=this.lastLanding;this._autoOpenTimer&&window.clearTimeout(this._autoOpenTimer);var s=n.parentNode,o=e.parentObject;s.idd||(s.grid=this,this.dadmodefix=0);var u=new dragContext(0,0,0,s.grid.dadmode==1||s.grid.dadmodec?"sibling":"child");if(o&&o.childNodes)u.set("source","tree").set("sobj",o.treeNod).set("sid",u.sobj._dragged);else{if(!o)return!0;o.treeNod.isTreeGrid&&o.treeNod.isTreeGrid()&&u.set("source","treeGrid"),u.set("sobj",o.treeNod).set("sid",u.sobj._dragged)}s.grid.isTreeGrid()?u.set("target","treeGrid"):u.set("dropmode","sibling"),u.set("tobj",s.grid).set("tid",s.idd);var a=this.getFirstParentOfType(r,"TD");a&&u.set("tExtra",a._cellIndex),a&&u.set("sExtra",u.sobj._dndExtra),u.sobj.dpcpy&&u.set("mode","copy"),u.tobj._realfake&&(u.tobj=u.tobj._fake),u.sobj._realfake&&(u.sobj=u.sobj._fake),u.tobj._clearMove();if(o&&o.treeNod&&o.treeNod._nonTrivialRow)o.treeNod._nonTrivialRow(this,u.tid,u.dropmode,o);else{u.tobj.dragContext=u;if(!u.tobj.callEvent("onDrag",[u.slist(),u.tid,u.sobj,u.tobj,u.sExtra,u.tExtra]))return u.tobj.dragContext=null;var f=[];if(typeof u.sid=="object"){for(var l=u.copy(),c=0;c<u.sid.length;c++)l.set("alfa",!c).set("sid",u.sid[c][u.source=="tree"?"id":"idd"]).valid()&&(l.tobj._dragRoutine(l),l.target=="treeGrid"&&l.dropmode=="child"&&l.tobj.openItem(l.tid),f[f.length]=l.nid,l.set("dropmode","sibling").set("tid",l.nid));l.close()}else u.tobj._dragRoutine(u);u.tobj.laterLink&&u.tobj.laterLink(),u.tobj.callEvent("onDrop",[u.slist(),u.tid,f.join(","),u.sobj,u.tobj,u.sExtra,u.tExtra])}u.tobj.dragContext=null,u.close()},dhtmlXGridObject.prototype._dragRoutine=function(e){if(e.sobj==e.tobj&&e.source=="grid"&&e.mode=="move"&&!this._fake){if(!e.sobj._dndProblematic){var t=e.sobj.rowsAr[e.sid],n=e.sobj.rowsCol._dhx_find(t);e.sobj.rowsCol._dhx_removeAt(e.sobj.rowsCol._dhx_find(t)),e.sobj.rowsBuffer._dhx_removeAt(e.sobj.rowsBuffer._dhx_find(t)),e.sobj.rowsBuffer._dhx_insertAt(e.ind(),t);if(e.tobj._fake){e.tobj._fake.rowsCol._dhx_removeAt(n);var r=e.tobj._fake.rowsAr[e.sid];r.parentNode.removeChild(r)}e.sobj._insertRowAt(t,e.ind()),e.nid=e.sid,e.sobj.callEvent("onGridReconstructed",[])}}else{var i;this._h2&&typeof e.tid!="undefined"&&e.dropmode=="sibling"&&(this._sbmod||e.tid)?e.alfa&&this._sbmod&&this._h2.get[e.tid].childs.length?(this.openItem(e.tid),i=e.uid().tobj.addRowBefore(e.nid,e.data(),this._h2.get[e.tid].childs[0].id,e.img(),e.childs())):i=e.uid().tobj.addRowAfter(e.nid,e.data(),e.tid,e.img(),e.childs()):i=e.uid().tobj.addRow(e.nid,e.data(),e.ind(),e.pid(),e.img(),e.childs()),i._attrs=e.attrs();if(e.source=="tree"){this.callEvent("onRowAdded",[e.nid]);var s=e.sobj._globalIdStorageFind(e.sid);if(s.childsCount){for(var o=e.copy().set("tid",e.nid).set("dropmode",e.target=="grid"?"sibling":"child"),u=0;u<s.childsCount;u++)e.tobj._dragRoutine(o.set("sid",s.childNodes[u].id)),e.mode=="move"&&u--;o.close()}}else if(e.tobj._copyUserData(e),this.callEvent("onRowAdded",[e.nid]),e.source=="treeGrid"){e.sobj==e.tobj&&(i._xml=e.sobj.rowsAr[e.sid]._xml);var a=e.sobj._h2.get[e.sid];if(a&&a.childs.length){o=e.copy().set("tid",e.nid),e.target=="grid"?o.set("dropmode","sibling"):(o.tobj.openItem(e.tid),o.set("dropmode","child"));for(var f=a.childs.length,u=0;u<f;u++)if(e.sobj.render_row_tree(null,a.childs[u].id),e.tobj._dragRoutine(o.set("sid",a.childs[u].id)),f!=a.childs.length)u--,f=a.childs.length;o.close()}}e.mode=="move"&&(e.sobj[e.source=="tree"?"deleteItem":"deleteRow"](e.sid),e.sobj==e.tobj&&!e.tobj.rowsAr[e.sid])&&(e.tobj.changeRowId(e.nid,e.sid),e.nid=e.sid)}},dhtmlXGridObject.prototype.gridToGrid=function(e,t){for(var n=[],r=0;r<t.hdr.rows[0].cells.length;r++)n[r]=t.cells(e,r).getValue();return n},dhtmlXGridObject.prototype.checkParentLine=function(e,t){return!this._h2||!t||!e?!1:e.id==t?!0:this.checkParentLine(e.parent,t)},dhtmlXGridObject.prototype._dragIn=function(e,t,n,r){if(!this.dADTempOff)return 0;var i=this.isTreeGrid(),s=t.parentNode.idd?t.parentNode:t.parentObject;if(this._drag_validate){if(e.parentNode==t.parentNode)return 0;if(i&&this==s.grid&&this.checkParentLine(this._h2.get[e.parentNode.idd],t.parentNode.idd))return 0}return this.callEvent("onDragIn",[s.idd||s.id,e.parentNode.idd,s.grid||s.treeNod,e.grid||e.parentNode.grid])?(this._setMove(e,n,r),i&&e.parentNode.expand!=""?(this._autoOpenTimer=window.setTimeout(new callerFunction(this._autoOpenItem,this),1e3),this._autoOpenId=e.parentNode.idd):this._autoOpenTimer&&window.clearTimeout(this._autoOpenTimer),e):this._setMove(e,n,r,!0)},dhtmlXGridObject.prototype._autoOpenItem=function(e,t){t.openItem(t._autoOpenId)},dhtmlXGridObject.prototype._dragOut=function(e){this._clearMove();var t=e.parentNode.parentObject?e.parentObject.id:e.parentNode.idd;this.callEvent("onDragOut",[t]),this._autoOpenTimer&&window.clearTimeout(this._autoOpenTimer)},dhtmlXGridObject.prototype._setMove=function(e,t,n,r){if(e.parentNode.idd){var i=getAbsoluteTop(e),s=getAbsoluteTop(this.objBox);i-s>parseInt(this.objBox.offsetHeight)-50&&(this.objBox.scrollTop=parseInt(this.objBox.scrollTop)+20),i-s+parseInt(this.objBox.scrollTop)<parseInt(this.objBox.scrollTop)+30&&(this.objBox.scrollTop=parseInt(this.objBox.scrollTop)-20);if(r)return 0;if(this.dadmode==2){var o=n-i+(document.body.scrollTop||document.documentElement.scrollTop)-2-e.offsetHeight/2;Math.abs(o)-e.offsetHeight/6>0?(this.dadmodec=1,this.dadmodefix=o<0?-1:1):this.dadmodec=0}else this.dadmodec=this.dadmode;if(this.dadmodec)this._sdrgc||this._createSdrgc(),this._sdrgc.style.display="block",this._sdrgc.style.top=i-s+parseInt(this.objBox.scrollTop)+(this.dadmodefix>=0?e.offsetHeight:0)+"px";else if(this._llSelD=e,e.parentNode.tagName=="TR")for(var u=0;u<e.parentNode.childNodes.length;u++)o=e.parentNode.childNodes[u],o._bgCol=o.style.backgroundColor,o.style.backgroundColor="#FFCCCC"}},dhtmlXGridObject.prototype._clearMove=function(){this._sdrgc&&(this._sdrgc.style.display="none");if(this._llSelD&&this._llSelD.parentNode.tagName=="TR")for(var e=this._llSelD.parentNode.childNodes,t=0;t<e.length;t++)e[t].style.backgroundColor=e[t]._bgCol;this._llSelD=null},dhtmlXGridObject.prototype.rowToDragElement=function(e){var t=this.cells(e,0).getValue();return t},dhtmlXGridObject.prototype._copyUserData=function(e){if(!e.tobj.UserData[e.nid]||e.tobj!=e.sobj){e.tobj.UserData[e.nid]=new Hashtable;var t=e.sobj.UserData[e.sid],n=e.tobj.UserData[e.nid];t&&(n.keys=n.keys.concat(t.keys),n.values=n.values.concat(t.values))}},dhtmlXGridObject.prototype.moveRow=function(e,t,n,r){switch(t){case"row_sibling":this.moveRowTo(e,n,"move","sibling",this,r);break;case"up":this.moveRowUp(e);break;case"down":this.moveRowDown(e)}};